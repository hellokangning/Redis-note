AOF（Append Only File）持久化，与RDB持久化通过保存数据库中的键值对来记录数据库状态不同，AOF保存Redis所执行的写命令来记录数据库状态。被写入AOF文件的命令都是以Redis的命令请求协议格式保存的，纯文本格式，打开即可查看。

# 11.1 AOF持久化的实现

AOF持久化功能的实现可分为命令追加（append）、文件写入、文件同步（sync）三个步骤。

## 命令追加

如果打开AOF功能，服务器在执行完一个写命令后，会以协议格式将被执行的命令追加到服务器状态的`aof_buf`缓冲区的末尾。

```objective-c
struct redisServer {
  // ...
  sds aof_buf;
  // ...
};
```

## AOF文件的写入与同步

Redis的服务器进程就是一个事件循环（loop），这个循环中的文件事件负责接受客户端的请求，并向客户端发送回复，而时间事件则负责执行像`serverCron`函数这样的定时任务。

服务器在处理文件任务时可能会执行写命令，追加内容到`aof_buf`缓冲区，所以服务器在每次结束一个事件循环前，都会调用`flushAppendOnlyFile`，考虑是否将缓冲区的内容写入到AOF文件中。

> flushAppendOnlyFile函数的行为由服务器配置的`appendfsync`选项的值来决定：always、everysec（默认）、no。

# 11.2 AOF文件的载入与数据还原

