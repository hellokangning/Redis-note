Redis的发布与订阅功能由`PUBLISH`、`SUBSCRIBE`、`PSUBSCRIBE`等命令组成。

通过执行`SUBSCRIBE`命令，客户端可以订阅一个或多个频道，成为这些频道的订阅者（subscriber）：每当有其他客户端向被订阅的频道发送消息时，频道的所有订阅者都会收到这条消息。

客户端还可以通过`PSUBSCRIBE`订阅一个或多个模式：每当有其他客户端向某个频道发送消息，消息不仅会发送给这个频道的订阅者，还会发送给与这个频道相匹配的模式的订阅者。

# 18.1 频道的订阅与退订

Redis将所有频道的订阅关系都保存在服务器状态的`pubsub_channles`字典中，键是某个被订阅的频道，值是一个链表，里面记录了所有订阅这个频道的客户端：

```c
struct redisServer {
  dict *pubsub_channels;
};
```

## 订阅频道

每当客户端执行`SUBSCRIBE`命令时，服务器都会将客户端与被订阅的频道在`pubsub_channles`字典中关联：

- 如果频道已有其他订阅者，将当前客户端添加到订阅者链表的末尾。
- 如果频道未有订阅者，则在`pubsub_channles`字典中创建一个键，并将客户端添加至链表。

## 退订频道

`UNSUBSCRIBE`命令让客户端退订某个频道，服务器从`pubsub_channles`字典中解除关联：

- 根据被退订频道的名字，在`pubsub_channles`字典中找到订阅者链表，移除退订客户端的信息。
- 如果链表变成了空，则从`pubsub_channles`字典中删除频道对应的键。

# 18.2 模式的订阅与退订



# 导航

[目录](README.md)

上一章：[17. 集群](17. 集群.md)

下一章：