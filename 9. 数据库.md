# 9.1 服务器中的数据库

Redis服务器将所有数据库都保存在服务器状态redis.h/redisServer结构的db数组中，数组的每个项都是一个redis.h/redisDb结构，每个redisDb结构代表一个数据库：

```c
struct redisServer {
  // ...
  redisDb *db;
  int dbnum; // 数据库的数量
  // ...
};
```

其中dbnum的值有服务器配置的database选项决定，默认为16。

# 9.2 切换数据库

默认情况下，Redis客户端的目标数据库是0号数据库，客户端可以执行SELECT命令来切换。

服务器内部，客户端状态redisClient结构的db属性记录了客户端当前的目标数据库：

```c
typedef struct redisClient {
  redisDb *db; // 指向redisServer.db数组中的一个元素
} redusClient;
```

# 9.3 数据库键空间

Redis是一个键值对（key-value pair）数据库服务器。redisDb结构的dict字典保存了数据库的所有键值对，这个字典就是键空间：

```c
typedef struct redisDb {
  dict *dict;
} redisDb;
```

键空间和用户所见的数据库是直接对应的：

- 键空间的键也就是数据库的键。每个键都是一个字符串对象。
- 键空间的值也是数据库的值。每个值可以使字符串对象、列表对象、哈希表对象、集合对象、有序集合对象。

![](img/chap9/img0.png)

所有针对数据库的操作，实际上都是通过键空间字典来实现。

## 添加新键

添加一个新键值对到数据库，就是将新键值对添加到键空间字典中。

## 删除键

删除数据库中的一个键，就是在键空间中删除键所对应的键值对对象。

## 更新键

更新数据库的一个键，就是对键空间里键所对应的值对象进行更新。根据值对象类型的不同，更新的具体方法也不同。

## 对键取值

对一个数据库键取值，就是在键空间中取出键所对应的值对象。

## 读写键空间时的维护操作

当Redis对数据库读写时，不仅对键空间执行指定的操作，还会执行一些额外的维护：

1. 读取一个键后，更新服务器的键命中次数或不命中次数。这两个值可通过INFO stats命令查看。
2. 读取一个键后，更新LRU时间。OBJECT idletime \<key\>查看。
3. 读取键时发现已过期，删除。
4. 如果有客户端WATCH了某个键，修改后将键标记为dirty，从而让事物程序注意到它。
5. 每次修改一个键后，将dirty键计数器的值+1，这个计数器会触发服务器的持久化和赋值操作。
6. 如果服务器开启了通知功能，键修改后，服务器会按照配置发送通知。

# 9.4 设置键的生存时间或过期时间

